<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="EllisNewman"><link rel="icon" href="/icon.png"><title>星之海原 - Hoshiumi -</title><meta name="description"><link rel="alternate" type="application/rss+xml" title="星之海原 - Hoshiumi -" href="/atom.xml"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/highlight.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">星之海原 - Hoshiumi -</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/tags/">分类</a></li><li><a href="/archives/">归档</a></li><li><a href="/lab/">lab</a></li><li><a href="/about/">关于</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/icon.png" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>从Unity开发者角度对MLTD进行的一些考察</h1><p class="post-meta">Posted on 11月 4 2018 · <a href="/tags/im-s/" class="tag post-meta">im@s</a> · <a href="/tags/技术/" class="tag post-meta">技术</a></p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>自己对于Unity开发，特别是基于Unity的手游开发仍在学习当中。在玩mltd的同时，也有从开发者角度对mltd进行观察，收集情报，以及一定程度的拆包，以期从mltd这个项目中学到一点开发相关的经验。同时也部分了解了mltd的素材资源获取机制，尝试用c#写成了一点小工具获取和处理游戏资源，在这里一并进行经验总结和讨论。</p>
<h2 id="版本之争"><a href="#版本之争" class="headerlink" title="版本之争"></a>版本之争</h2><p>开发之初，mltd团队采用的Unity版本为5.6。从内部版本号14585开始，Unity版本被更新到了2017.3。时间是在今年4月。</p>
<p>一般来讲，在项目中途更改Unity版本并不是一件特别提倡的事情。不同版本间API的实现和调用情况可能会有不同，整个工程转换后版本容易引发各种预料不到的问题。今年5月的Unite Tokyo 2018大会上mltd团队分享开发经验的时候（就是akane大作战那次），在PPT里面写道「游戏发布之后再对Unity版本升级相当不容易，慎重！」 ，想来恐怕也是踩了些坑。（笑）</p>
<p>不过自己印象中API改动较大的版本是在5.4左右，5.6之后相对来讲问题不算太严重。况且2017系列版本确实新加了不少新功能，进行升级确实有一定的必要性。举个例子，2017版本有了更好的AR支持。而mltd就实装了AR功能，并在一周年活动和感谢祭活动期间开放AR供玩家使用。因此倒推回去猜测，Unity版本升级或许就是开发团队在部署这样的考量和布局。可以认为升级Unity版本既是开发者最适化自身开发环境的需要，也是mltd本身不断进化，不断提升品质的基础。</p>
<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><p>客户端开发采用了谁都知道的Unity，而服务端方面，BNSI的选择则是谷歌全家桶（误）Google Cloud Platform，应用了其中Google App Engine、 BigQuery、 Cloud Datastore等多项服务，还使用了Go语言，在搭建服务端功能、获取数据分析等服务的基础上，实现了动态调配服务器资源以适应突发高频率访问等情况，同时保证服务端数据能够被高速存取。服务端自己并不是特别熟悉，更多技术细节可参考这篇实质GCP广告(x)的<a href="https://cloudplatform-jp.googleblog.com/2018/07/google-app-engine-bandainamcostudios.html" target="_blank" rel="noopener">Blog</a>进行了解。</p>
<p>服务端提供的另一个功能，是为玩家提供游戏资源文件的下载服务。同本世代许多其他的手游一样，mltd的安装包进行了足够的精简，只保留了游戏运行所需要的最基本的素材资源，其他许多内容则是在需要用到的时候，再从服务端下载获取。具体的实现机制后面再细讲。</p>
<p>下载的过程中总会有个进度条，因此游戏初期也被一些玩家称为“读条大师”。自己倒是认为，这至少也比过去那些先下载几个G的资源，然后才能开始玩的手游要友好得多。当然，在进入游戏后自己能选择一次性下载完所有资源，能以后不用再读条的话也是个选择。mltd实际也追加了这个功能，不过实现得有些迷，在一些地方仍然会读条下载。似乎这个一键下载功能没能够把所有资源都下载下来，效果不是特别理想。</p>
<h2 id="安装包瘦身"><a href="#安装包瘦身" class="headerlink" title="安装包瘦身"></a>安装包瘦身</h2><p>随着一款游戏在运营过程中推陈出新，游戏本体和安装包的容量都会变得越来越大。尽管说现在都8012年了，不会有人心疼多出来那么十来MB的流量就取消下载拒绝一款游戏，但是能够压缩的资源就尽量压缩，能复用节省空间的就尽量节省，多抠细节总不是坏事。</p>
<p>=</p>
<p>这是手头一点并不完整的mltd各个版本安装包的列表。虽然样本不够多，但大致能够这样认为，在安装包随着版本号的升高而不断臃肿的同时，开发团队采取了行动，对安装包进行瘦身。</p>
<p>瘦身的方式是，将原本一些封存在安装包中的资源素材挪到服务端上面去，需要用到的时候再进行下载。具体挪了哪些素材，一一列举出来并没有什么意义，不如讲一个事例。</p>
<p>可能有同僚会记得，一周年活动结束之后的一段时间里，mltd偶尔会出现这样一个BUG。在剧场中点击“设施移动”，显示出四个房间供玩家选择的时候，如果某一房间内有可以互动的偶像，那么该房间选项的右下角会显示该偶像的头像，头上还有一个“…”的气泡。而出现的BUG则是，偶像头像消失不见了，只剩下头上的气泡。出现这个BUG的根本原因，正是小偶像们的头像文件，被从安装包中挪到服务端上了。而直接原因，可能是网络状况不良或者下载过程中出错，或者相关逻辑实现得并不好，没有对头像文件进行预载等等等等。总之，这个BUG算是安装包瘦身所产生的一点小小的副作用。想来头像这种需要立即使用，等不及慢慢地请求服务端响应再慢慢下载的东西，恐怕还是放在本地随取随用比较好。</p>
<h2 id="图像资源"><a href="#图像资源" class="headerlink" title="图像资源"></a>图像资源</h2><p>先请允许自己怀个旧。以前一段时间曾折腾过CS所用的Quake2引擎（以Valve自家的叫法则是“GoldSrc”金源，是起源引擎的前身），借由其关卡编辑器制作CS的关卡地图。这个上世纪末诞生的东西对于导入引擎的贴图素材有着严格的限制。图片必须使用BMP格式，24位，256色。alpha通道自然是没有的，要想贴图带有透明镂空效果，得把透明部分填充成 RGB 0,0,255 的纯蓝色（和BMBB素材同理）。甚至图片尺寸也限制为必须是2的次幂，比如单张贴图得是256x256或者512x512，即使贴图实际上不是方形，也得先按这个尺寸做，再导入进编辑器进行平铺或者拉伸。而现在都已经8012年，主流引擎早已没有这些奇奇怪怪的要求了，各种常见格式的图片都能够很好地支持，尺寸方面自然任意大小也都能够导入。</p>
<p>不过从优化的角度，为了便于各类图像压缩算法对贴图进行压缩处理，仍然可以将图像尺寸限定在2的次幂内。并且包括Unity在内的主流引擎也都支持图集功能，将多张尺寸较小的素材图片放在同一张图内，导入进引擎之后再分别拆分出来进行使用，既能够高效压缩图片，又能减少使用时读取资源文件的次数。</p>
<p>mltld的各类素材资源基本为1024x1024或512x512。像按钮、窗口等细小的UI元素，就直接放到一起拼装成单个图集，2d背景、卡面立绘等实际为矩形的图像，也在拆分之后拼成规则的正方形贴图。</p>
<p>=</p>
<h2 id="资源索引"><a href="#资源索引" class="headerlink" title="资源索引"></a>资源索引</h2><p>前面也提到了，mltd的游戏资源放在服务器上，通过Unity拆分为许多个单独的AssetBundle。在游戏过程中需要用到某个资源时，客户端先检测本地是否存放有该资源文件，版本是否为最新，不是则向服务器请求进行下载。</p>
<p>为了实现这个机制，客户端中使用一个索引文件来存放所有资源文件的信息。就像是一个商品目录，记载了所有商品的名称、描述和编号。使用者根据名字找到想要的商品之后，向商家报上商品编号，就能</p>
<p>(to be continued…)</p>
</article><ul class="pager blog-pager"><li class="next"><a href="/2018/11/01/into-the-wing/" data-toggle="tooltip" data-placement="top" title="Into the W.I.N.G.">下一篇</a></li></ul></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="mailto:ellisnewmanem@outlook.com" title="Email me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-envelope"></i></span></a></li><li><a href="https://twitter.com/ellisnewman8" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-twitter"></i></span></a></li><li><a href="https://github.com/ellisnewman" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="http://weibo.com/athrunv" title="Weibo"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-weibo"></i></span></a></li></ul><p class="copyright text-muted">© EllisNewman • 2018 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script><script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script></body></html>